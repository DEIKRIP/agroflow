import{x as l}from"./index-BAZ5r3BO.js";const g=async s=>{try{const{error:e}=await l.from("bolivarDigitalClients").delete().eq("id",s);if(e)throw e;return{success:!0,message:"Cliente eliminado exitosamente"}}catch(e){return console.error("Error al eliminar cliente:",e),{success:!1,message:"Error al eliminar el cliente",error:e.message}}};async function h(){const s=["Activo","En Seguimiento","Cosechado","Incumplido"],{data:e,error:i}=await l.from("bolivarDigitalFinanciamientos").select("id, clientId, parcelaId, monto, totalPagado, estado, proposito, numeroCosechas").in("estado",s).order("id",{ascending:!1});if(i)throw i;const a=Array.from(new Set((e||[]).map(r=>r.clientId).filter(Boolean)));let o=new Map;if(a.length>0){const{data:r,error:c}=await l.from("bolivarDigitalClients").select("id, fullName").in("id",a);if(c)throw c;for(const f of r||[])o.set(f.id,{fullName:f.fullName})}return(e||[]).map(r=>{var c;return{...r,clientName:(c=o.get(r.clientId))==null?void 0:c.fullName}})}async function p(){const{data:s,error:e}=await l.from("bolivarDigitalPayments").select("id, clientId, financiamientoId, fecha, monto, montoRetenido, gananciaAgricultor, metodo").order("fecha",{ascending:!1});if(e)throw e;const i=Array.from(new Set((s||[]).map(t=>t.clientId).filter(Boolean))),a=Array.from(new Set((s||[]).map(t=>t.financiamientoId).filter(Boolean))),[o,r]=await Promise.all([i.length?l.from("bolivarDigitalClients").select("id, fullName").in("id",i):Promise.resolve({data:[],error:null}),a.length?l.from("bolivarDigitalFinanciamientos").select("id, proposito").in("id",a):Promise.resolve({data:[],error:null})]);if(o.error)throw o.error;if(r.error)throw r.error;const c=new Map;for(const t of o.data||[])c.set(t.id,{fullName:t.fullName});const f=new Map;for(const t of r.data||[])f.set(t.id,{proposito:t.proposito});return(s||[]).map(t=>{var m,d;return{...t,clientName:((m=c.get(t.clientId))==null?void 0:m.fullName)||"Desconocido",proposito:((d=f.get(t.financiamientoId))==null?void 0:d.proposito)||"N/A"}})}async function I(s){const e=s.trim();if(!e)return[];const[i,a]=await Promise.all([l.from("bolivarDigitalClients").select("id, fullName, cedula, rif").ilike("fullName",`%${e}%`).limit(5),l.from("bolivarDigitalClients").select("id, fullName, cedula, rif").ilike("cedula",`%${e}%`).limit(5)]);if(i.error)throw i.error;if(a.error)throw a.error;const o=new Map;for(const n of i.data||[])o.set(n.id,n);for(const n of a.data||[])o.set(n.id,n);const r=Array.from(o.values());if(r.length===0)return[];const c=["Activo","En Seguimiento","Cosechado","Incumplido"],f=r.map(n=>n.id),{data:t,error:m}=await l.from("bolivarDigitalFinanciamientos").select("id, clientId, monto, totalPagado, estado, proposito, numeroCosechas").in("clientId",f).in("estado",c);if(m)throw m;const d=new Map;for(const n of t||[])d.has(n.clientId)||d.set(n.clientId,[]),d.get(n.clientId).push(n);return r.map(n=>({...n,financiamientos:d.get(n.id)||[]}))}async function v(s,e){try{const i=String(e.get("clientId")||""),a=String(e.get("financiamientoId")||""),o=String(e.get("fecha")||""),r=String(e.get("monto")||""),c=String(e.get("metodo")||""),f=String(e.get("referenciaCosecha")||""),t={};o||(t.fecha="La fecha es requerida");const m=Number(r);if((!r||isNaN(m)||m<=0)&&(t.monto="Ingrese un monto válido"),c||(t.metodo="Seleccione un método de pago"),i||(t.clientId="Falta clientId"),a||(t.financiamientoId="Falta financiamientoId"),Object.keys(t).length>0)return{success:!1,message:"Revise los campos",errors:t};const{error:d}=await l.from("bolivarDigitalPayments").insert({clientId:i,financiamientoId:a,fecha:o,monto:m,metodo:c,referenciaCosecha:f||null,createdAt:new Date().toISOString()});if(d)throw d;return{success:!0,message:"Pago registrado correctamente"}}catch(i){return console.error("addPaymentAction error",i),{success:!1,message:"No se pudo registrar el pago"}}}async function w(s,e){const i=Number(e.get("harvestValue")||""),a=String(e.get("frequency")||""),o={};return(!i||isNaN(i)||i<=0)&&(o.harvestValue="Ingrese un valor válido"),a||(o.frequency="Seleccione una frecuencia"),Object.keys(o).length?{success:!1,message:"Revise los campos",errors:o}:{success:!0,message:"Cronograma generado"}}const y=async s=>{try{const{data:e,error:i}=await l.from("bolivarDigitalClients").upsert([s],{onConflict:"id"});if(i)throw i;return{success:!0,message:"Cliente guardado exitosamente",data:e==null?void 0:e[0]}}catch(e){return console.error("Error al guardar cliente:",e),{success:!1,message:"Error al guardar el cliente",error:e.message}}};export{v as a,I as b,p as c,g as d,w as g,h as l,y as s};
//# sourceMappingURL=bolivarDigitalActions-Dx5-RAqw.js.map
