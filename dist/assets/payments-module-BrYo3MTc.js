import{r,j as e,D as I,C as V,H as M,T as k,e as G,L as C,I as P,E as q,f as O,F as z,G as H,B as D,a as K,J as R,K as E,M as L,N as T,Q as U,U as B,V as W,X as J,Y as Q}from"./index-BAZ5r3BO.js";import{a as X,l as Y,b as _,c as Z}from"./bolivarDigitalActions-Dx5-RAqw.js";import{C as d,a as m,b as x,c as w,d as h}from"./Card-DsCaw10F.js";import{S as $}from"./skeleton-BBn7ZAan.js";import{u as ee}from"./use-toast-BUI7Dgf-.js";function se(){const{pending:t}=K.useFormStatus();return e.jsx(D,{type:"submit",disabled:t,children:t?"Registrando...":"Registrar Pago"})}function te({isOpen:t,setIsOpen:l,financiamiento:i,clientName:F}){var p,u,S,j;const[a,N,y]=r.useActionState(X,null),[b,c]=r.useState("Efectivo"),{toast:f}=ee(),g=r.useRef(null),v=(i.monto||0)-(i.totalPagado??0);return r.useEffect(()=>{var o;t||((o=g.current)==null||o.reset(),c("Efectivo"))},[t]),r.useEffect(()=>{y||!a||(a.success?(f({title:"Éxito",description:a.message||"Pago registrado"}),l(!1)):f({title:"Error",description:a.message||"No se pudo registrar el pago",variant:"destructive"}))},[a,y,f,l]),e.jsx(I,{open:t,onOpenChange:l,children:e.jsxs(V,{className:"sm:max-w-md",children:[e.jsxs(M,{children:[e.jsx(k,{children:"Registrar Pago de Cosecha"}),e.jsxs(G,{children:["Registrar el ingreso de una venta de cosecha para ",e.jsx("strong",{children:F}),". El sistema aplicará la retención correspondiente al crédito.",e.jsxs("div",{className:"flex justify-between text-sm mt-2 font-medium",children:[e.jsxs("span",{children:["Monto del crédito: ",e.jsxs("span",{className:"text-foreground",children:["Bs. ",(i.monto||0).toLocaleString("es-VE",{minimumFractionDigits:2})]})]}),e.jsxs("span",{children:["Saldo Pendiente: ",e.jsxs("span",{className:"text-primary",children:["Bs. ",v.toLocaleString("es-VE",{minimumFractionDigits:2})]})]})]})]})]}),e.jsxs("form",{ref:g,action:N,className:"space-y-4",children:[e.jsx("input",{type:"hidden",name:"clientId",value:String(i.clientId||"")}),e.jsx("input",{type:"hidden",name:"financiamientoId",value:String(i.id||"")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(C,{htmlFor:"fecha",children:"Fecha del Pago"}),e.jsx(P,{id:"fecha",name:"fecha",type:"date",required:!0,defaultValue:new Date().toISOString().split("T")[0]}),((p=a==null?void 0:a.errors)==null?void 0:p.fecha)&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.errors.fecha})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"monto",children:"Monto Total Venta (Bs.)"}),e.jsx(P,{id:"monto",name:"monto",type:"number",step:"0.01",required:!0,placeholder:"Total de la venta"}),((u=a==null?void 0:a.errors)==null?void 0:u.monto)&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.errors.monto})]})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"metodo",children:"Método de Pago"}),e.jsx(q,{id:"metodo",name:"metodo",required:!0,value:b,onChange:o=>c(o),placeholder:"Seleccione un método...",options:[{value:"Efectivo",label:"Efectivo"},{value:"Transferencia",label:"Transferencia"},{value:"Patria",label:"Patria"},{value:"Otro",label:"Otro"}]}),((S=a==null?void 0:a.errors)==null?void 0:S.metodo)&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.errors.metodo})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"referenciaCosecha",children:"Referencia Cosecha (Opcional)"}),e.jsx(O,{id:"referenciaCosecha",name:"referenciaCosecha",placeholder:"Ej: Cosecha de Maíz ciclo invierno 2024"}),((j=a==null?void 0:a.errors)==null?void 0:j.referenciaCosecha)&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.errors.referenciaCosecha})]}),e.jsxs(z,{children:[e.jsx(H,{asChild:!0,children:e.jsx(D,{type:"button",variant:"secondary",children:"Cancelar"})}),e.jsx(se,{})]})]})]})})}const A=({financiamiento:t})=>{const[l,i]=r.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(d,{className:"bg-muted/30",children:[e.jsxs(m,{className:"pb-2",children:[e.jsxs(x,{className:"text-base flex items-center justify-between",children:[e.jsx("span",{children:t.proposito}),e.jsxs(D,{size:"sm",onClick:()=>i(!0),children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),"Pagar"]})]}),e.jsxs(w,{children:["Sujeto: ",t.clientName||"Cargando..."]})]}),e.jsx(h,{className:"text-sm",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{children:["Monto: ",e.jsxs("span",{className:"font-semibold",children:["Bs. ",(t.monto||0).toLocaleString("es-VE")]})]}),e.jsxs("p",{children:["Pagado: ",e.jsxs("span",{className:"font-semibold text-green-600",children:["Bs. ",(t.totalPagado||0).toLocaleString("es-VE")]})]}),e.jsx("span",{className:"px-2 py-1 text-xs rounded border text-muted-foreground",children:t.estado})]})})]}),e.jsx(te,{isOpen:l,setIsOpen:i,financiamiento:t,clientName:t.clientName||""})]})},ae=({client:t})=>e.jsxs(d,{children:[e.jsxs(m,{className:"pb-4",children:[e.jsxs(x,{className:"text-lg flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-primary"}),t.fullName]}),e.jsxs(w,{children:["Cédula: ",t.cedula," | RIF: ",t.rif]})]}),e.jsxs(h,{children:[e.jsx("h4",{className:"mb-2 font-medium text-sm text-muted-foreground",children:"Financiamientos Activos"}),e.jsx("div",{className:"space-y-2",children:t.financiamientos.length>0?t.financiamientos.map(l=>e.jsx(A,{financiamiento:{...l,clientName:t.fullName}},l.id)):e.jsx("p",{className:"text-sm text-center text-muted-foreground py-4 bg-muted/20 rounded-md",children:"No tiene financiamientos activos."})})]})]});function ce(){const[t,l]=r.useState([]),[i,F]=r.useState([]),[a,N]=r.useState(!0),[y,b]=r.useState(!0),[c,f]=r.useState(""),[g,v]=r.useState(!1),[p,u]=r.useState([]);r.useEffect(()=>{let s=!1;return(async()=>{N(!0);try{const n=await Y();s||F(n)}catch(n){console.error("Error loading active financiamientos",n)}finally{s||N(!1)}})(),()=>{s=!0}},[]);const S=r.useCallback(async()=>{if(!c.trim()){u([]);return}v(!0),u([]);try{const s=await _(c);u(s)}catch(s){console.error("Error searching clients:",s)}finally{v(!1)}},[c]);r.useEffect(()=>{let s=!1;return(async()=>{b(!0);try{const n=await Z();s||l(n)}catch(n){console.error("Error loading pagos",n)}finally{s||b(!1)}})(),()=>{s=!0}},[]);const j=r.useMemo(()=>t.reduce((s,n)=>(s.totalIngresos+=Number(n.monto)||0,s.totalRetenido+=Number(n.montoRetenido)||0,s.totalGananciaProductores+=Number(n.gananciaAgricultor)||0,s),{totalIngresos:0,totalRetenido:0,totalGananciaProductores:0}),[t]),o=y;return e.jsxs("div",{className:"h-full flex flex-col gap-8 p-1",children:[e.jsxs(d,{children:[e.jsxs(m,{children:[e.jsx(x,{children:"Financiamientos Activos"}),e.jsx(w,{children:"Lista de todos los créditos que están actualmente en ciclo de pago. Registre un nuevo pago directamente desde aquí."})]}),e.jsxs(h,{className:"space-y-3",children:[a&&e.jsx("div",{className:"flex justify-center items-center p-8",children:e.jsx(R,{className:"animate-spin h-8 w-8 text-primary"})}),!a&&i.length>0&&i.map(s=>e.jsx(A,{financiamiento:s},s.id)),!a&&i.length===0&&e.jsx("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No hay financiamientos activos en este momento."})]})]}),e.jsxs(d,{className:"flex-grow flex flex-col",children:[e.jsxs(m,{children:[e.jsx(x,{className:"text-2xl font-semibold text-foreground",children:"Historial y KPIs Financieros"}),e.jsx(w,{children:"Registro centralizado de todos los abonos y análisis de la rentabilidad del modelo. También puede buscar un cliente para registrar un pago."}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3 pt-6",children:[e.jsxs(d,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Ingresos Totales"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(h,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["Bs. ",j.totalIngresos.toLocaleString("es-VE",{minimumFractionDigits:2})]})})]}),e.jsxs(d,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Ganancia SiembraPaís (Retención)"}),e.jsx(L,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(h,{children:e.jsxs("div",{className:"text-2xl font-bold text-primary",children:["Bs. ",j.totalRetenido.toLocaleString("es-VE",{minimumFractionDigits:2})]})})]}),e.jsxs(d,{children:[e.jsxs(m,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Ganancia Productores"}),e.jsx(T,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(h,{children:e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:["Bs. ",j.totalGananciaProductores.toLocaleString("es-VE",{minimumFractionDigits:2})]})})]})]})]}),e.jsxs(h,{className:"flex-grow flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(U,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground"}),e.jsx(P,{placeholder:"Buscar cliente por nombre o cédula para registrar pago...",className:"pl-10",value:c,onChange:s=>f(s.target.value),onKeyDown:s=>s.key==="Enter"&&S()})]}),g&&e.jsx("div",{className:"flex justify-center items-center p-4",children:e.jsx(R,{className:"animate-spin h-6 w-6 text-primary"})}),!g&&p.length>0&&e.jsx("div",{className:"space-y-4 mt-4 border-t pt-4",children:p.map(s=>e.jsx(ae,{client:s},s.id))})]}),e.jsxs("div",{className:"flex-grow overflow-auto",children:[o&&e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((s,n)=>e.jsx($,{className:"h-12 w-full"},n))}),!o&&t.length===0&&e.jsxs("div",{className:"text-center py-16 border-2 border-dashed rounded-lg h-full flex flex-col justify-center",children:[e.jsx(E,{className:"mx-auto h-12 w-12 text-muted-foreground"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-foreground",children:"No se han registrado pagos"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"El historial de pagos aparecerá aquí."})]}),!o&&t.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-muted",children:e.jsxs("tr",{children:[e.jsxs("th",{className:"text-left py-2",children:[e.jsx(B,{className:"inline mr-1"}),"Sujeto"]}),e.jsxs("th",{className:"text-left py-2",children:[e.jsx(W,{className:"inline mr-1"}),"Fecha"]}),e.jsxs("th",{className:"text-right py-2",children:[e.jsx(E,{className:"inline mr-1"}),"Monto Total"]}),e.jsxs("th",{className:"text-right py-2",children:[e.jsx(L,{className:"inline mr-1"}),"Monto Retenido"]}),e.jsxs("th",{className:"text-right py-2",children:[e.jsx(T,{className:"inline mr-1"}),"Ganancia Productor"]}),e.jsx("th",{className:"text-left py-2",children:"Método"}),e.jsxs("th",{className:"text-left py-2",children:[e.jsx(J,{className:"inline mr-1"}),"Crédito Asociado"]})]})}),e.jsx("tbody",{children:t.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-2 font-medium",children:s.clientName}),e.jsx("td",{className:"py-2",children:new Date(s.fecha).toLocaleDateString()}),e.jsxs("td",{className:"py-2 text-right font-semibold text-foreground",children:["Bs. ",Number(s.monto||0).toLocaleString("es-VE",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-2 text-right text-primary font-medium",children:["Bs. ",Number(s.montoRetenido||0).toLocaleString("es-VE",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-2 text-right text-green-600 font-medium",children:["Bs. ",Number(s.gananciaAgricultor||0).toLocaleString("es-VE",{minimumFractionDigits:2})]}),e.jsx("td",{className:"py-2",children:e.jsx("span",{className:"inline-block px-2 py-1 rounded bg-muted capitalize",children:s.metodo})}),e.jsx("td",{className:"py-2 text-muted-foreground text-xs",children:s.proposito})]},s.id))})]})})]})]})]})]})}export{ce as default};
//# sourceMappingURL=payments-module-BrYo3MTc.js.map
